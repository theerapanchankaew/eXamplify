rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function hasValidUserCreateData(userId) {
      return request.resource.data.id == userId;
    }
    
    function isChangingOnlyRole() {
      return request.resource.data.keys().size() == 1 && 'role' in request.resource.data;
    }

    function isRoleUnchanged() {
      return !('role' in request.resource.data) || request.resource.data.role == resource.data.role;
    }

    function isInstructor() {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return user.data.role == 'Instructor';
    }

    function isCourseInstructor(courseId) {
      let course = get(/databases/$(database)/documents/courses/$(courseId));
      return isSignedIn() && course.data.instructorId == request.auth.uid;
    }

    function isEnrolled(courseId) {
      return isSignedIn() && exists(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId));
    }

    // ------------------------------------------------------------------------
    // Administrative Collections
    // ------------------------------------------------------------------------

    match /roles_admin/{userId} {
      allow read, write: if isAdmin();
    }

    match /audit_logs/{auditLogId} {
      allow get, list: if isAdmin();
      allow create, update, delete: if false;
    }

    // ------------------------------------------------------------------------
    // User Data Collections
    // ------------------------------------------------------------------------

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && hasValidUserCreateData(userId) || isAdmin();
      allow update: if (isAdmin() && isChangingOnlyRole()) || (isOwner(userId) && isRoleUnchanged());
      allow delete: if isAdmin();
    }

    match /users/{userId}/certificates/{certificateId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId); 
      allow update, delete: if false;
    }

    match /users/{userId}/tokenTransactions/{transactionId} {
      allow get, list: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) || isAdmin();
      allow update, delete: if false;
    }

    // ------------------------------------------------------------------------
    // Course and Content Collections
    // ------------------------------------------------------------------------

    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.instructorId == request.auth.uid;
      allow update: if (isCourseInstructor(courseId) || isAdmin()) || 
                    (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['enrollment_count']));
      allow delete: if isCourseInstructor(courseId) || isAdmin();
      
      match /exams/{examId} {
        allow get, list: if isSignedIn();
        allow create: if isAdmin() || isInstructor();
        allow update, delete: if isAdmin() || isInstructor();
        
        match /questions/{questionId} {
          allow get, list: if isSignedIn();
          allow create, update, delete: if isAdmin() || isInstructor();
        }
      }
    }

    match /courses/{courseId}/modules/{moduleId} {
      allow get, list: if isSignedIn();
      allow create: if (isCourseInstructor(courseId) || isAdmin()) && request.resource.data.courseId == courseId;
      allow update, delete: if isCourseInstructor(courseId) || isAdmin();
    }

    match /courses/{courseId}/modules/{moduleId}/chapters/{chapterId} {
      allow get, list: if isEnrolled(courseId) || isCourseInstructor(courseId) || isAdmin();
      allow create: if (isCourseInstructor(courseId) || isAdmin()) && request.resource.data.moduleId == moduleId;
      allow update, delete: if isCourseInstructor(courseId) || isAdmin();
    }

    match /courses/{courseId}/modules/{moduleId}/chapters/{chapterId}/lessons/{lessonId} {
      allow get, list: if isEnrolled(courseId) || isCourseInstructor(courseId) || isAdmin();
      allow create: if (isCourseInstructor(courseId) || isAdmin()) && request.resource.data.chapterId == chapterId;
      allow update, delete: if isCourseInstructor(courseId) || isAdmin();
      allow update: if isOwner(resource.data.userId) || isCourseInstructor(resource.data.courseId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isCourseInstructor(resource.data.courseId) || isAdmin();
    }

    match /{path=**}/exams/{examId} {
        allow read: if isSignedIn();
    }

    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && (
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'commentsCount'])) || 
        resource.data.authorId == request.auth.uid || 
        isAdmin()
      );
      allow delete: if resource.data.authorId == request.auth.uid || isAdmin();
    }

    match /posts/{postId}/comments/{commentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if resource.data.authorId == request.auth.uid || isAdmin();
    }

    match /enrollments/{enrollmentId} {
      allow get: if isSignedIn() && (isOwner(resource.data.userId) || isCourseInstructor(resource.data.courseId) || isAdmin());
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isCourseInstructor(resource.data.courseId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isCourseInstructor(resource.data.courseId) || isAdmin();
    }

    match /examResults/{resultId} {
      allow get: if isSignedIn() && (isOwner(resource.data.userId) || isAdmin());
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ------------------------------------------------------------------------
    // Marketplace Collections (Phase 2)
    // ------------------------------------------------------------------------

    match /cart/{userId}/items/{itemId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update, delete: if isOwner(userId);
    }

    match /orders/{orderId} {
      allow get: if isSignedIn() && (isOwner(resource.data.userId) || isAdmin());
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /vouchers/{voucherId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // ------------------------------------------------------------------------
    // Exam Scheduling Collections (Phase 3)
    // ------------------------------------------------------------------------

    match /examSchedules/{scheduleId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || isInstructor();
      allow update: if isAdmin() || isInstructor() || isSignedIn();
      allow delete: if isAdmin() || isInstructor();
    }

    match /bookings/{bookingId} {
      allow get: if isSignedIn() && (isOwner(resource.data.userId) || isAdmin());
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ------------------------------------------------------------------------
    // System Master Data (Public Read, Admin Write)
    // ------------------------------------------------------------------------

    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    match /competencies/{competencyId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    match /course_competencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // ------------------------------------------------------------------------
    // Master Courses (Admin and Instructor Management)
    // ------------------------------------------------------------------------

    match /masterCourses/{masterCourseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin() || isInstructor();
    }

    match /question_competencies/{questionCompetencyId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}